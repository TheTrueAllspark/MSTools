<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Template Generator</title>
    <style>
        /* Base styles - will be modified by theme */
        :root {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #27ae60;
            --secondary-hover: #219653;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #f5f7fa;
            --card-bg: white;
            --text-color: #333;
            --border-color: #f0f0f0;
            --highlight-bg: #f1f9ff;
        }
        
        /* Themes */
        body.theme-blue {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #27ae60;
            --secondary-hover: #219653;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #f5f7fa;
            --card-bg: white;
            --text-color: #333;
            --border-color: #f0f0f0;
            --highlight-bg: #f1f9ff;
        }
        
        body.theme-purple {
            --primary-color: #9b59b6;
            --primary-hover: #8e44ad;
            --secondary-color: #27ae60;
            --secondary-hover: #219653;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #f8f5fa;
            --card-bg: white;
            --text-color: #333;
            --border-color: #f0e0ff;
            --highlight-bg: #f5e9ff;
        }
        
        body.theme-green {
            --primary-color: #2ecc71;
            --primary-hover: #27ae60;
            --secondary-color: #3498db;
            --secondary-hover: #2980b9;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #f5faf7;
            --card-bg: white;
            --text-color: #333;
            --border-color: #e0f5e0;
            --highlight-bg: #e9ffef;
        }
        
        body.theme-dark {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-hover: #27ae60;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --border-color: #4a6278;
            --highlight-bg: #2d4257;
        }
        
        body.theme-light {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #27ae60;
            --secondary-hover: #219653;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --bg-color: #ffffff;
            --card-bg: #f9f9f9;
            --text-color: #333;
            --border-color: #e0e0e0;
            --highlight-bg: #f5f9fc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .form-section, .preview-section {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .preview-section {
            position: relative;
        }
        
        h2 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .conditional-fields-container {
            padding-left: 15px;
            border-left: 3px solid var(--primary-color);
            margin-top: 5px;
            margin-bottom: 15px;
            background-color: var(--highlight-bg);
            padding: 15px;
            border-radius: 0 4px 4px 0;
        }
        
        .add-more-link {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
            margin-bottom: 20px;
            text-decoration: underline;
        }
        
        .delete-group-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .delete-group-btn:hover {
            background-color: var(--danger-hover);
        }
        
        .additional-part-group {
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 30px;
            background-color: var(--highlight-bg);
            padding: 15px;
            border-radius: 4px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 15px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-copy {
            background-color: var(--secondary-color);
        }
        
        .btn-copy:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn-reset {
            background-color: var(--danger-color);
        }
        
        .btn-reset:hover {
            background-color: var(--danger-hover);
        }
        
        .button-group {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }
        
        #preview {
            background-color: var(--highlight-bg);
            padding: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            min-height: 300px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 15px;
            overflow-y: auto;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .copy-message {
            position: absolute;
            top: 25px;
            right: 25px;
            background-color: var(--secondary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .copy-message.show {
            opacity: 1;
        }
        
        .template-controls {
            margin-bottom: 30px;
        }
        
        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 15px;
            margin-right: 10px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        /* Theme selector */
        .theme-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .theme-selector select {
            padding: 8px 12px;
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .theme-selector {
                position: static;
                margin-bottom: 20px;
                text-align: right;
            }
        }
    </style>
</head>
<body class="theme-blue">
    <!-- Theme selector -->
    <div class="theme-selector">
        <select id="theme-select">
            <option value="blue">Blue Theme</option>
            <option value="purple">Light Purple</option>
            <option value="green">Light Green</option>
            <option value="dark">Dark Mode</option>
            <option value="light">Light Mode</option>
        </select>
    </div>

    <h1>Note Template Generator</h1>
    
    <div class="container">
        <div class="form-section">
            <h2>Template Input</h2>
            
            <div class="template-controls">
                <label for="template-select">Choose a template:</label>
                <select id="template-select">
                    <option value="breakfix">Break/Fix Task Notes</option>
                    <option value="dbd">DBD Task Notes</option>
                    <option value="networking">Networking Task Notes</option>
                    <option value="meeting">Meeting Note</option>
                    <option value="project">Project Update</option>
                    <option value="workwindow">Work Window Request Email</option>
                    <option value="custom">Custom Template</option>
                </select>
            </div>
            
            <form id="template-form">
                <!-- Fields will be dynamically generated here -->
            </form>
        </div>
        
        <div class="preview-section">
            <h2>Note Preview</h2>
            <div id="preview">Your compiled note will appear here...</div>
            <div class="button-group">
                <button type="button" class="btn btn-copy" id="copy-btn">Copy to Clipboard</button>
                <button type="button" class="btn btn-reset" id="reset-btn">Reset</button>
            </div>
            <div class="copy-message" id="copy-message">Note copied to clipboard!</div>
        </div>
    </div>

    <script>
        // Template definitions
        const templates = {
            breakfix: {
                title: "Break/Fix Task Notes",
                fields: [
                    { name: "taskId", label: "Task ID", type: "text" },
                    { name: "assetTagConfirmed", label: "Was the asset tag visually confirmed?", type: "select", options: ["Yes", "No"] },
                    { name: "uponArrival", label: "Upon Arrival:", type: "textarea" },
                    { name: "partReplaced", label: "Part(s) Replaced", type: "text" },
                    { name: "oldSerialNumber", label: "Old Serial Number", type: "text" },
                    { name: "newSerialNumber", label: "New Serial Number", type: "text" },
                    { name: "licensePlate", label: "License Plate", type: "text" },
                    { name: "actionsTaken", label: "Actions Taken", type: "textarea" },
                    { name: "wasEscalated", label: "Was this ticket escalated?", type: "checkbox", hasConditionalFields: true },
                    { name: "escalatedTo", label: "Who was it escalated to?", type: "text", conditionalOn: { field: "wasEscalated", value: "checked" } },
                    { name: "seniorTechAlias", label: "Alias of the senior who approved this:", type: "text", conditionalOn: { field: "wasEscalated", value: "checked" } }
                ],
                format: (data) => {
                    let escalationInfo = "";
                    if (data.wasEscalated === "checked") {
                        escalationInfo = `
ESCALATION DETAILS:
- Escalated To: ${data.escalatedTo || "[Not specified]"}
- Senior Tech Approval: ${data.seniorTechAlias || "[Not specified]"}`;
                    }
                    
                    return `TASK ID: ${data.taskId || "[No ID]"}
ASSET TAG CONFIRMED: ${data.assetTagConfirmed || "N/A"}

UPON ARRIVAL:
${data.uponArrival || "[No arrival notes recorded]"}

PART(S) REPLACED: ${data.partReplaced || "N/A"}
OLD SERIAL NUMBER: ${data.oldSerialNumber || "N/A"}
NEW SERIAL NUMBER: ${data.newSerialNumber || "N/A"}
LICENSE PLATE: ${data.licensePlate || "N/A"}

ACTIONS TAKEN:
${data.actionsTaken || "[No actions recorded]"}

TICKET ESCALATED: ${data.wasEscalated === "checked" ? "Yes" : "No"}${escalationInfo}`;
                }
            },
            dbd: {
                title: "DBD Task Notes",
                fields: [
                    { name: "taskId", label: "Task ID", type: "text" },
                    { name: "assetTagConfirmed", label: "Was the asset tag visually confirmed?", type: "select", options: ["Yes", "No"] },
                    { name: "uponArrival", label: "Upon Arrival:", type: "textarea" },
                    { name: "partReplaced", label: "Part(s) Replaced", type: "text" },
                    { name: "oldSerialNumber", label: "Old Serial Number", type: "text" },
                    { name: "newSerialNumber", label: "New Serial Number", type: "text" },
                    { name: "licensePlate", label: "License Plate", type: "text" },
                    { name: "driveLocation", label: "Location of drive being replaced", type: "text" },
                    { name: "binNumber", label: "Bin #", type: "text" },
                    { name: "properDiscard", label: "Was the drive discarded in the proper DBD bin?", type: "select", options: ["Yes", "No"] },
                    { name: "actionsTaken", label: "Actions Taken", type: "textarea" },
                    { name: "wasEscalated", label: "Was this ticket escalated?", type: "checkbox", hasConditionalFields: true },
                    { name: "escalatedTo", label: "Who was it escalated to?", type: "text", conditionalOn: { field: "wasEscalated", value: "checked" } },
                    { name: "seniorTechAlias", label: "Alias of the senior who approved this:", type: "text", conditionalOn: { field: "wasEscalated", value: "checked" } }
                ],
                format: (data) => {
                    let escalationInfo = "";
                    if (data.wasEscalated === "checked") {
                        escalationInfo = `
ESCALATION DETAILS:
- Escalated To: ${data.escalatedTo || "[Not specified]"}
- Senior Tech Approval: ${data.seniorTechAlias || "[Not specified]"}`;
                    }
                    
                    return `TASK ID: ${data.taskId || "[No ID]"}
ASSET TAG CONFIRMED: ${data.assetTagConfirmed || "N/A"}

UPON ARRIVAL:
${data.uponArrival || "[No arrival notes recorded]"}

PART(S) REPLACED: ${data.partReplaced || "N/A"}
OLD SERIAL NUMBER: ${data.oldSerialNumber || "N/A"}
NEW SERIAL NUMBER: ${data.newSerialNumber || "N/A"}
LICENSE PLATE: ${data.licensePlate || "N/A"}
DRIVE LOCATION: ${data.driveLocation || "N/A"}
BIN #: ${data.binNumber || "N/A"}
DRIVE DISCARDED IN PROPER DBD BIN: ${data.properDiscard || "N/A"}

ACTIONS TAKEN:
${data.actionsTaken || "[No actions recorded]"}

TICKET ESCALATED: ${data.wasEscalated === "checked" ? "Yes" : "No"}${escalationInfo}`;
                }
            },
            networking: {
                title: "Networking Task Notes",
                fields: [
                    { name: "taskId", label: "Task ID", type: "text" },
                    { name: "assetTagConfirmed", label: "Was the asset tag visually confirmed?", type: "select", options: ["Yes", "No"] },
                    { name: "uponArrival", label: "Upon Arrival:", type: "textarea" },
                    { name: "sourceDevice", label: "Source Device:Port", type: "text" },
                    { name: "endDevice", label: "End Device:Port", type: "text" },
                    { name: "partReplaced", label: "Part(s) Replaced", type: "text" },
                    { name: "oldSerialNumber", label: "Old Serial Number", type: "text" },
                    { name: "newSerialNumber", label: "New Serial Number", type: "text" },
                    { name: "licensePlate", label: "License Plate", type: "text" },
                    { name: "actionsTaken", label: "Actions Taken", type: "textarea" },
                    { name: "wasEscalated", label: "Was this ticket escalated?", type: "select", options: ["Yes", "No"], hasConditionalFields: true },
                    { name: "escalatedTo", label: "Who was this escalated to?", type: "text", conditionalOn: { field: "wasEscalated", value: "Yes" } },
                    { name: "seniorTechAlias", label: "Alias of Senior that approved the escalation:", type: "text", conditionalOn: { field: "wasEscalated", value: "Yes" } }
                ],
                format: (data) => {
                    let escalationInfo = "";
                    if (data.wasEscalated === "checked") {
                        escalationInfo = `
ESCALATION DETAILS:
- Escalated To: ${data.escalatedTo || "[Not specified]"}
- Senior Tech Approval: ${data.seniorTechAlias || "[Not specified]"}`;
                    }
                    
                    return `TASK ID: ${data.taskId || "[No ID]"}
ASSET TAG CONFIRMED: ${data.assetTagConfirmed || "N/A"}

UPON ARRIVAL:
${data.uponArrival || "[No arrival notes recorded]"}

SOURCE DEVICE:PORT: ${data.sourceDevice || "N/A"}
END DEVICE:PORT: ${data.endDevice || "N/A"}
PART(S) REPLACED: ${data.partReplaced || "N/A"}
OLD SERIAL NUMBER: ${data.oldSerialNumber || "N/A"}
NEW SERIAL NUMBER: ${data.newSerialNumber || "N/A"}
LICENSE PLATE: ${data.licensePlate || "N/A"}

ACTIONS TAKEN:
${data.actionsTaken || "[No actions recorded]"}

TICKET ESCALATED: ${data.wasEscalated === "checked" ? "Yes" : "No"}${escalationInfo}`;
                }
            },
            meeting: {
                title: "Meeting Note",
                fields: [
                    { name: "meetingTitle", label: "Meeting Title", type: "text" },
                    { name: "date", label: "Date & Time", type: "text" },
                    { name: "attendees", label: "Attendees", type: "text" },
                    { name: "agenda", label: "Agenda", type: "textarea" },
                    { name: "decisions", label: "Key Decisions", type: "textarea" },
                    { name: "actionItems", label: "Action Items", type: "textarea" }
                ],
                format: (data) => {
                    return `MEETING: ${data.meetingTitle || "[No Title]"}
DATE: ${data.date || "N/A"}
ATTENDEES: ${data.attendees || "N/A"}

AGENDA:
${data.agenda || "[No agenda items]"}

KEY DECISIONS:
${data.decisions || "[No decisions recorded]"}

ACTION ITEMS:
${data.actionItems || "[No action items]"}`;
                }
            },
            project: {
                title: "Project Update",
                fields: [
                    { name: "projectName", label: "Project Name", type: "text" },
                    { name: "status", label: "Current Status", type: "text" },
                    { name: "accomplishments", label: "Recent Accomplishments", type: "textarea" },
                    { name: "challenges", label: "Current Challenges", type: "textarea" },
                    { name: "nextSteps", label: "Next Steps", type: "textarea" },
                    { name: "resources", label: "Required Resources", type: "textarea" }
                ],
                format: (data) => {
                    return `PROJECT UPDATE: ${data.projectName || "[No Project Name]"}
STATUS: ${data.status || "N/A"}

RECENT ACCOMPLISHMENTS:
${data.accomplishments || "[None recorded]"}

CURRENT CHALLENGES:
${data.challenges || "[None recorded]"}

NEXT STEPS:
${data.nextSteps || "[None planned]"}

REQUIRED RESOURCES:
${data.resources || "[None specified]"}`;
                }
            },
            workwindow: {
                title: "Work Window Request Email",
                fields: [
                    { name: "taskId", label: "Task ID", type: "text" },
                    { name: "date", label: "Date", type: "text" },
                    { name: "time", label: "Time", type: "text" }
                ],
                format: (data) => {
                    return `WORK WINDOW REQUEST - TASK ID: ${data.taskId || "[No ID]"}

Hello, 

We need to schedule a work window for task # ${data.taskId || "SlotA"}. The next available date we have for this work window is ${data.date || "SlotB"} at ${data.time || "SlotC"}. Does this work for you? 

NOTE: For every work window we will need a MINIMUM of 24 hours' notice so that SS can confirm availability. Important! Please remove traffic if necessary to facilitate a timely start for the WW event.`;
                }
            },
            custom: {
                title: "Custom Template",
                fields: [
                    { name: "customTitle", label: "Note Title", type: "text" },
                    { name: "customTemplate", label: "Custom Template (Use ## to denote where input values will go)", type: "textarea" },
                    { name: "customValues", label: "Values (one per line, in order of ##)", type: "textarea" }
                ],
                format: (data) => {
                    let result = `${data.customTitle || "Custom Note"}\n\n`;
                    
                    if (data.customTemplate) {
                        let template = data.customTemplate;
                        const values = data.customValues ? data.customValues.split('\n').filter(v => v.trim()) : [];
                        
                        values.forEach(value => {
                            template = template.replace('##', value);
                        });
                        
                        // Replace any remaining ## with blank
                        template = template.replace(/##/g, '[empty]');
                        
                        result += template;
                    } else {
                        result += "[No custom template defined]";
                    }
                    
                    return result;
                }
            }
        };

        // Current template and parts counter
        let currentTemplate = 'breakfix';
        let additionalPartsCounter = 0;
        
        // DOM elements
        const templateForm = document.getElementById('template-form');
        const previewDiv = document.getElementById('preview');
        const templateSelect = document.getElementById('template-select');
        const copyBtn = document.getElementById('copy-btn');
        const resetBtn = document.getElementById('reset-btn');
        const copyMessage = document.getElementById('copy-message');
        
        // Initialize with the default template
        generateFormFields();
        
        // Add event listeners
        templateSelect.addEventListener('change', changeTemplate);
        copyBtn.addEventListener('click', copyToClipboard);
        resetBtn.addEventListener('click', resetForm);
        
        // Theme selector event listener
        const themeSelect = document.getElementById('theme-select');
        themeSelect.addEventListener('change', function() {
            const selectedTheme = this.value;
            setTheme(selectedTheme);
        });
        
        // Function to set the theme
        function setTheme(theme) {
            // Remove all theme classes
            document.body.classList.remove('theme-blue', 'theme-purple', 'theme-green', 'theme-dark', 'theme-light');
            // Add the selected theme class
            document.body.classList.add(`theme-${theme}`);
            
            // Save the theme preference to localStorage
            localStorage.setItem('preferredTheme', theme);
        }
        
        // Load saved theme preference if it exists
        const savedTheme = localStorage.getItem('preferredTheme');
        if (savedTheme) {
            themeSelect.value = savedTheme;
            setTheme(savedTheme);
        }
        
        // Function to change template
        function changeTemplate() {
            currentTemplate = templateSelect.value;
            generateFormFields();
            updatePreview();
        }
        
        // Function to generate form fields based on selected template
        function generateFormFields() {
            templateForm.innerHTML = '';
            additionalPartsCounter = 0;
            
            const template = templates[currentTemplate];
            
            // First pass: Create all regular fields (non-conditional)
            template.fields.forEach(field => {
                // Skip conditional fields - we'll add them after their parent field
                if (field.conditionalOn) {
                    return;
                }
                
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.setAttribute('for', field.name);
                label.textContent = field.label;
                
                // Create the input based on field type
                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                } else if (field.type === 'select' && field.options) {
                    input = document.createElement('select');
                    // Add an empty option first
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select --';
                    input.appendChild(emptyOption);
                    
                    // Add the rest of the options
                    field.options.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        input.appendChild(option);
                    });
                } else if (field.type === 'checkbox') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.style.marginLeft = '0';
                    input.style.marginTop = '10px';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                }
                
                input.id = field.name;
                input.name = field.name;
                
                // Add event listeners
                if (field.type === 'checkbox' && field.hasConditionalFields) {
                    input.addEventListener('change', function() {
                        updateConditionalFieldsVisibility(this);
                        updatePreview();
                    });
                } else if (field.type === 'select' && field.hasConditionalFields) {
                    input.addEventListener('change', handleConditionalFields);
                } else {
                    input.addEventListener('input', updatePreview);
                }
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                templateForm.appendChild(formGroup);
                
                // If this field has conditional fields, add them right after it
                if (field.hasConditionalFields) {
                    // Find all conditional fields that depend on this field
                    const conditionalFields = template.fields.filter(f => 
                        f.conditionalOn && f.conditionalOn.field === field.name
                    );
                    
                    // Create a container for the conditional fields
                    const conditionalContainer = document.createElement('div');
                    conditionalContainer.id = `conditional-container-${field.name}`;
                    conditionalContainer.className = 'conditional-fields-container';
                    conditionalContainer.style.display = 'none';
                    conditionalContainer.style.paddingLeft = '15px';
                    conditionalContainer.style.borderLeft = '3px solid #3498db';
                    conditionalContainer.style.marginTop = '5px';
                    conditionalContainer.style.marginBottom = '15px';
                    conditionalContainer.style.backgroundColor = '#f1f9ff';
                    conditionalContainer.style.padding = '15px';
                    
                    // Add each conditional field to the container
                    conditionalFields.forEach(condField => {
                        const condFormGroup = document.createElement('div');
                        condFormGroup.className = 'form-group';
                        
                        const condLabel = document.createElement('label');
                        condLabel.setAttribute('for', condField.name);
                        condLabel.textContent = condField.label;
                        
                        let condInput;
                        if (condField.type === 'textarea') {
                            condInput = document.createElement('textarea');
                        } else {
                            condInput = document.createElement('input');
                            condInput.type = condField.type;
                        }
                        
                        condInput.id = condField.name;
                        condInput.name = condField.name;
                        condInput.addEventListener('input', updatePreview);
                        
                        condFormGroup.appendChild(condLabel);
                        condFormGroup.appendChild(condInput);
                        conditionalContainer.appendChild(condFormGroup);
                    });
                    
                    // Add the conditional container after the parent field
                    templateForm.appendChild(conditionalContainer);
                    
                    // Check initial state (for when the form is reset but the triggering field is set)
                    if ((field.type === 'checkbox' && input.checked) || 
                        (field.type === 'select' && input.value === conditionalFields[0].conditionalOn.value)) {
                        conditionalContainer.style.display = 'block';
                    }
                }
                
                // Create container for additional parts after the appropriate field
                if ((field.name === 'licensePlate' && currentTemplate === 'breakfix') ||
                    (field.name === 'properDiscard' && currentTemplate === 'dbd') ||
                    (field.name === 'licensePlate' && currentTemplate === 'networking')) {
                    
                    const additionalPartsContainer = document.createElement('div');
                    additionalPartsContainer.id = 'additional-parts-container';
                    templateForm.appendChild(additionalPartsContainer);
                    
                    // Add the "Add More Parts" link
                    addAddMoreButton(templateForm);
                }
            });
        }
        
        // Function to update visibility of conditional fields based on checkbox state
        function updateConditionalFieldsVisibility(checkbox) {
            const container = document.getElementById(`conditional-container-${checkbox.id}`);
            if (container) {
                if (checkbox.checked) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    // Clear all input fields in the container
                    const inputs = container.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => input.value = '');
                }
            }
        }
        
        // Function to add the "Add More Parts" button
        function addAddMoreButton(parentElement) {
            const existingButton = document.getElementById('add-more-container');
            if (existingButton) {
                existingButton.remove();
            }
            
            const addMoreContainer = document.createElement('div');
            addMoreContainer.id = 'add-more-container';
            
            const addMoreLink = document.createElement('div');
            addMoreLink.className = 'add-more-link';
            addMoreLink.textContent = '+ Add More Parts';
            addMoreLink.addEventListener('click', addMoreParts);
            
            addMoreContainer.appendChild(addMoreLink);
            parentElement.appendChild(addMoreContainer);
        }
        
        // Function to check if conditional field should be shown
        function shouldShowConditionalField(field) {
            if (!field.conditionalOn) return true;
            
            const dependsOnField = document.getElementById(field.conditionalOn.field);
            if (!dependsOnField) return false;
            
            // For checkbox dependency
            if (dependsOnField.type === 'checkbox') {
                return (field.conditionalOn.value === "checked" && dependsOnField.checked);
            }
            // For select or other field types
            return dependsOnField.value === field.conditionalOn.value;
        }
        
        // Function to handle showing/hiding conditional fields
        function handleConditionalFields(event) {
            const triggerField = event.target;
            const triggerValue = triggerField.value;
            const conditionalFields = document.querySelectorAll(`.conditional-field[data-depends-on="${triggerField.id}"]`);
            
            conditionalFields.forEach(field => {
                const requiredValue = field.getAttribute('data-depends-value');
                if (triggerValue === requiredValue) {
                    field.style.display = 'block';
                } else {
                    field.style.display = 'none';
                    // Clear values in hidden fields
                    const inputs = field.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => input.value = '');
                }
            });
            
            updatePreview();
        }
        
        // Function to add more parts
        function addMoreParts() {
            additionalPartsCounter++;
            const container = document.getElementById('additional-parts-container');
            
            const partGroup = document.createElement('div');
            partGroup.className = 'additional-part-group';
            partGroup.id = `additional-part-${additionalPartsCounter}`;
            
            // Create a heading
            const heading = document.createElement('h4');
            heading.textContent = `Additional Part ${additionalPartsCounter}`;
            heading.style.marginTop = '0';
            partGroup.appendChild(heading);
            
            // Create common fields for all templates
            createFormField(partGroup, 'Old Serial Number', `oldSerialNumber${additionalPartsCounter}`, 'text');
            createFormField(partGroup, 'New Serial Number', `newSerialNumber${additionalPartsCounter}`, 'text');
            createFormField(partGroup, 'License Plate', `licensePlate${additionalPartsCounter}`, 'text');
            
            // Add DBD-specific fields
            if (currentTemplate === 'dbd') {
                createFormField(partGroup, 'Location of drive being replaced', `driveLocation${additionalPartsCounter}`, 'text');
                createFormField(partGroup, 'Bin #', `binNumber${additionalPartsCounter}`, 'text');
                
                // Add select field for proper discard
                const properDiscardGroup = document.createElement('div');
                properDiscardGroup.className = 'form-group';
                
                const properDiscardLabel = document.createElement('label');
                properDiscardLabel.setAttribute('for', `properDiscard${additionalPartsCounter}`);
                properDiscardLabel.textContent = 'Was the drive discarded in the proper DBD bin?';
                
                const properDiscardInput = document.createElement('select');
                properDiscardInput.id = `properDiscard${additionalPartsCounter}`;
                properDiscardInput.name = `properDiscard${additionalPartsCounter}`;
                
                // Add options
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select --';
                properDiscardInput.appendChild(emptyOption);
                
                ["Yes", "No"].forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    properDiscardInput.appendChild(option);
                });
                
                properDiscardInput.addEventListener('input', updatePreview);
                
                properDiscardGroup.appendChild(properDiscardLabel);
                properDiscardGroup.appendChild(properDiscardInput);
                partGroup.appendChild(properDiscardGroup);
            }
            
            // Add Delete button
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-group-btn';
            deleteButton.textContent = 'Delete this part';
            deleteButton.setAttribute('type', 'button');
            deleteButton.setAttribute('data-part-id', additionalPartsCounter);
            deleteButton.onclick = function() {
                deletePartGroup(this.getAttribute('data-part-id'));
            };
            
            partGroup.appendChild(deleteButton);
            container.appendChild(partGroup);
            
            updatePreview();
            
            // Move the Add More button
            addAddMoreButton(container);
        }
        
        // Helper function to create form fields
        function createFormField(parent, labelText, fieldId, fieldType) {
            const group = document.createElement('div');
            group.className = 'form-group';
            
            const label = document.createElement('label');
            label.setAttribute('for', fieldId);
            label.textContent = labelText;
            
            const input = document.createElement('input');
            input.type = fieldType;
            input.id = fieldId;
            input.name = fieldId;
            input.addEventListener('input', updatePreview);
            
            group.appendChild(label);
            group.appendChild(input);
            parent.appendChild(group);
        }
        
        // Function to delete a part group
        function deletePartGroup(partId) {
            partId = String(partId);
            
            const partGroup = document.getElementById(`additional-part-${partId}`);
            if (partGroup) {
                partGroup.remove();
                updatePreview();
                
                const container = document.getElementById('additional-parts-container');
                const parts = container.querySelectorAll('.additional-part-group');
                
                if (parts.length > 0) {
                    addAddMoreButton(container);
                } else {
                    addAddMoreButton(templateForm);
                }
            }
        }
        
        // Function to update preview as user types
        function updatePreview() {
            const formData = {};
            const template = templates[currentTemplate];
            
            // Collect values from regular fields
            template.fields.forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    // Handle checkbox values differently
                    if (field.type === 'checkbox') {
                        formData[field.name] = input.checked ? "checked" : "";
                    } else {
                        formData[field.name] = input.value;
                    }
                }
            });
            
            // Collect values from additional parts
            if (['breakfix', 'dbd', 'networking'].includes(currentTemplate)) {
                formData.additionalParts = [];
                
                // Look for all additional parts in the DOM
                for (let i = 1; i <= additionalPartsCounter; i++) {
                    const partGroup = document.getElementById(`additional-part-${i}`);
                    if (partGroup) {
                        const oldSerial = document.getElementById(`oldSerialNumber${i}`);
                        const newSerial = document.getElementById(`newSerialNumber${i}`);
                        const licensePlate = document.getElementById(`licensePlate${i}`);
                        
                        if (oldSerial && newSerial && licensePlate) {
                            const partData = {
                                id: i,
                                oldSerialNumber: oldSerial.value,
                                newSerialNumber: newSerial.value,
                                licensePlate: licensePlate.value
                            };
                            
                            // Add DBD-specific fields
                            if (currentTemplate === 'dbd') {
                                const driveLocation = document.getElementById(`driveLocation${i}`);
                                const binNumber = document.getElementById(`binNumber${i}`);
                                const properDiscard = document.getElementById(`properDiscard${i}`);
                                
                                if (driveLocation) partData.driveLocation = driveLocation.value;
                                if (binNumber) partData.binNumber = binNumber.value;
                                if (properDiscard) partData.properDiscard = properDiscard.value;
                            }
                            
                            formData.additionalParts.push(partData);
                        }
                    }
                }
            }
            
            // Format the note
            let formattedNote = template.format(formData);
            
            // Add additional parts info to the formatted note
            if (['breakfix', 'dbd', 'networking'].includes(currentTemplate) && 
                formData.additionalParts && 
                formData.additionalParts.length > 0) {
                
                formattedNote += '\n\nADDITIONAL PARTS:';
                
                formData.additionalParts.forEach((part, index) => {
                    let additionalPartText = `\n\nPART #${index + 2}:
OLD SERIAL NUMBER: ${part.oldSerialNumber || "N/A"}
NEW SERIAL NUMBER: ${part.newSerialNumber || "N/A"}
LICENSE PLATE: ${part.licensePlate || "N/A"}`;
                    
                    // Add DBD-specific fields
                    if (currentTemplate === 'dbd') {
                        if (part.driveLocation !== undefined) {
                            additionalPartText += `\nDRIVE LOCATION: ${part.driveLocation || "N/A"}`;
                        }
                        if (part.binNumber !== undefined) {
                            additionalPartText += `\nBIN #: ${part.binNumber || "N/A"}`;
                        }
                        if (part.properDiscard !== undefined) {
                            additionalPartText += `\nDRIVE DISCARDED IN PROPER DBD BIN: ${part.properDiscard || "N/A"}`;
                        }
                    }
                    
                    formattedNote += additionalPartText;
                });
            }
            
            previewDiv.textContent = formattedNote;
        }
        
        // Function to copy to clipboard
        function copyToClipboard() {
            const noteText = previewDiv.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(noteText)
                    .then(() => showCopyMessage())
                    .catch(() => fallbackCopyTextToClipboard(noteText));
            } else {
                fallbackCopyTextToClipboard(noteText);
            }
        }
        
        // Show copy success message
        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 2000);
        }
        
        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Position offscreen
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showCopyMessage();
                } else {
                    console.error('Fallback: Could not copy text');
                    alert('Could not copy text. Please select the text manually.');
                }
            } catch (err) {
                console.error('Fallback: Could not copy text', err);
                alert('Could not copy text. Please select the text manually.');
            }
        }
        
        // Reset form function
        function resetForm() {
            templateForm.reset();
            
            // Reset conditional field containers
            document.querySelectorAll('.conditional-fields-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Reset checkboxes (they might not be properly reset by the form.reset())
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Remove additional parts
            const additionalPartsContainer = document.getElementById('additional-parts-container');
            if (additionalPartsContainer) {
                additionalPartsContainer.innerHTML = '';
            }
            additionalPartsCounter = 0;
            
            // Reset add more button position
            if (['breakfix', 'dbd', 'networking'].includes(currentTemplate)) {
                addAddMoreButton(templateForm);
            }
            
            updatePreview();
        }
    </script>
</body>
</html>
